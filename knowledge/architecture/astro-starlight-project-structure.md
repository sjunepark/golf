# Astro Docs: Complete Architecture Guide

## Overview

This is a sophisticated Astro documentation site built with **Starlight**, featuring:

- **Multi-language support** (14 languages)
- **Custom tabbed sidebar navigation**
- **Advanced content schemas and validation**
- **Comprehensive Starlight component customization**
- **AI-friendly content generation** (llms.txt)
- **Production-ready deployment pipeline**

## Architecture Components

### Core Configuration Stack

```text
â”Œâ”€ astro.config.ts (Main config)
â”‚  â”œâ”€ astro.sidebar.ts (Sidebar structure)
â”‚  â”‚  â””â”€ config/sidebar.ts (Internationalization helper)
â”‚  â”‚     â””â”€ src/content/nav/*.ts (Language labels)
â”‚  â”œâ”€ config/locales.ts (Language configuration)
â”‚  â””â”€ src/content.config.ts (Content schemas)
```

### Sidebar Architecture Deep Dive

#### 1. Configuration Flow

**Primary Configuration** (`astro.sidebar.ts`):

```typescript
export const sidebar = [
  // Each top-level group becomes a tab
  group('start', {
    items: [
      'getting-started',
      group('start.welcome', {
        items: ['concepts/why-astro', 'concepts/islands']
      }),
      // Mix of manual items and autogenerated directories
      group('start.migrate', {
        collapsed: true,
        autogenerate: { directory: 'guides/migrate-to-astro' }
      })
    ]
  })
];
```

**Internationalization Helper** (`config/sidebar.ts`):

```typescript
export function group(
  key: NavKey,
  group: Omit<StarlightManualSidebarGroup, 'label'>
): StarlightManualSidebarGroup {
  return {
    label: enLabels[key],           // English fallback
    translations: translations[key], // All language variants
    ...group,
  };
}
```

**Language Labels** (`src/content/nav/en.ts`):

```typescript
export default {
  start: 'Start',
  'start.welcome': 'Welcome, world!',
  guides: 'Guides and recipes',
  'guides.routing': 'Routing and navigation',
  // ... 30+ navigation keys
};
```

#### 2. Content Organization Strategy

**Directory Structure**:

```text
src/content/docs/
â”œâ”€â”€ en/                    # English (primary)
â”‚   â”œâ”€â”€ basics/           # Manual sidebar items
â”‚   â”œâ”€â”€ guides/
â”‚   â”‚   â”œâ”€â”€ deploy/       # Autogenerated section
â”‚   â”‚   â”œâ”€â”€ cms/          # Autogenerated section
â”‚   â”‚   â””â”€â”€ backend/      # Autogenerated section
â”‚   â”œâ”€â”€ recipes/          # Autogenerated section
â”‚   â””â”€â”€ reference/        # Manual sidebar items
â”œâ”€â”€ fr/                   # French translations
â”œâ”€â”€ es/                   # Spanish translations
â””â”€â”€ [12 more languages]   # Full i18n support
```

**Content-to-Sidebar Mapping**:

- **Manual Items**: `'getting-started'` â†’ `src/content/docs/en/getting-started.mdx`
- **Autogenerated**: `autogenerate: { directory: 'recipes' }` â†’ scans all `.mdx` files in `recipes/`
- **Nested Groups**: Unlimited nesting depth for complex hierarchies

### Advanced Content Schema System

#### Schema-Driven Content Types (`src/content.config.ts`)

```typescript
// Different content types with specific validation
export const recipeSchema = baseSchema.extend({
  type: z.literal('recipe'),
  description: z.string(),
  altTitle: z.string().optional(),
});

export const integrationSchema = baseSchema.extend({
  type: z.literal('integration'),
  title: z.string().refine(
    (title) => title.startsWith('@astrojs/'),
    '"title" must start with "@astrojs/" for integration docs.'
  ),
  category: z.enum(['renderer', 'adapter', 'other']),
  githubIntegrationURL: z.string().url(),
});

// Union type for all content schemas
export const docsCollectionSchema = z.union([
  baseSchema, backendSchema, cmsSchema, integrationSchema,
  mediaSchema, migrationSchema, tutorialSchema, deploySchema, recipeSchema
]);
```

**Benefits**:

- âœ… **Type Safety**: Full TypeScript validation
- âœ… **Content Validation**: Ensures required fields are present
- âœ… **Specialized Layouts**: Different content types can have custom layouts
- âœ… **Build-Time Checks**: Invalid content fails at build time

### Starlight Component Customization

#### Complete Component Override System

The project overrides **14 core Starlight components** for custom behavior:

```typescript
// astro.config.ts - Component overrides
components: {
  EditLink: './src/components/starlight/EditLink.astro',
  Head: './src/components/starlight/Head.astro',
  Hero: './src/components/starlight/Hero.astro',
  MarkdownContent: './src/components/starlight/MarkdownContent.astro',
  Sidebar: './src/components/starlight/Sidebar.astro',  // ðŸ”¥ Custom tabbed sidebar
  // ... 9 more custom components
}
```

#### Custom Tabbed Sidebar Implementation

**Key Features**:

- **5 Main Tabs**: Start, Guides, Reference, Integrations, Third-party
- **Dynamic Icons**: `['rocket', 'open-book', 'information', 'puzzle', 'setting']`
- **Current Page Detection**: Automatically highlights active tab
- **Fallback Indicators**: Shows "EN" badge for missing translations
- **Mobile Responsive**: Collapses to mobile-friendly format

**Technical Implementation** (`src/components/starlight/Sidebar.astro`):

```typescript
// Convert top-level groups to tabs
const makeId = (label: string) => '__tab-' + label.toLowerCase().replaceAll(/\s+/g, '-');
const getIcon = (index: number) => 
  (['rocket', 'open-book', 'information', 'puzzle', 'setting'] as const)[index];

// Detect current tab
const isCurrent = (sidebar: SidebarEntry[]): boolean =>
  sidebar.map(entry => 
    entry.type === 'link' ? entry.isCurrent : isCurrent(entry.entries)
  ).some(entry => entry === true);
```

### Internationalization System

#### Multi-Language Support (14 Languages)

**Language Configuration** (`src/languages.ts`):

```typescript
const allLanguages = {
  en: 'English',     de: 'Deutsch',      'pt-br': 'PortuguÃªs do Brasil',
  es: 'EspaÃ±ol',     'zh-cn': 'ç®€ä½“ä¸­æ–‡', 'zh-tw': 'æ­£é«”ä¸­æ–‡',
  fr: 'FranÃ§ais',    hi: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',      ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
  ja: 'æ—¥æœ¬èªž',       ko: 'í•œêµ­ì–´',       pl: 'Polski',
  ru: 'Ð ÑƒÑÑÐºÐ¸Ð¹',     it: 'Italiano'
};

export const rtlLanguages = new Set(['ar']); // Right-to-left support
```

**Locale Generation** (`config/locales.ts`):

```typescript
export function makeLocalesConfig(): StarlightLocalesConfig {
  return Object.fromEntries(
    Object.entries(languages).map(([locale, label]) => [
      locale,
      { 
        label, 
        lang: normalizeLangTag(locale), 
        dir: rtlLanguages.has(locale) ? 'rtl' : 'ltr' 
      }
    ])
  );
}
```

#### Translation Workflow

1. **Source Content**: Written in English (`src/content/docs/en/`)
2. **Translation Files**: Each language has its own directory
3. **Navigation Labels**: Centralized in `src/content/nav/*.ts`
4. **Fallback System**: Missing translations show English with "EN" badge
5. **Build Optimization**: Can build with only 2 languages for faster development

### Build System & Deployment

#### Development Workflow

**Scripts** (`package.json`):

```json
{
  "scripts": {
    "dev": "astro dev",                    // Development server
    "build": "astro build",               // Production build
    "docgen": "node ./scripts/docgen.mjs",       // Auto-generate API docs
    "lint:linkcheck": "pnpm build && tsm ./scripts/lint-linkcheck.ts", // Link validation
    "netlify:build": "pnpm ${NETLIFY_BUILD_SCRIPT:-build}"  // Netlify deployment
  }
}
```

**Key Dependencies**:

- **@astrojs/starlight**: ^0.31.1 (Documentation framework)
- **@expressive-code/plugin-collapsible-sections**: Code block enhancement
- **starlight-llms-txt**: ^0.5.1 (AI-friendly content generation)
- **sharp**: ^0.33.5 (Image optimization)

#### Production Features

**Performance Optimizations**:

- **Astro's Islands Architecture**: Minimal client-side JavaScript
- **Sharp Image Service**: Optimized image processing
- **Compression**: HTML compression disabled for better debugging
- **Scoped Styles**: `scopedStyleStrategy: 'where'` for better performance

**SEO & Metadata**:

- **Open Graph Images**: Dynamic OG image generation (`src/pages/open-graph/`)
- **Structured Data**: Rich content schemas
- **Sitemap Generation**: Automatic sitemap creation
- **Edit Links**: Direct GitHub edit links for each page

### AI-Friendly Features (llms.txt)

#### Comprehensive LLM Integration

The site generates **AI-optimized documentation** using the `starlight-llms-txt` plugin:

**Custom Content Sets**:

- **API Reference**: Terse, structured API descriptions
- **How-to Recipes**: Guided examples and tutorials
- **Deployment Guides**: Platform-specific deployment instructions
- **CMS Guides**: Content management system integrations
- **Migration Guides**: Framework migration advice

**Content Curation**:

- **Promoted Pages**: Key concepts appear first
- **Excluded Content**: Landing pages and legacy content filtered out
- **Multiple Formats**: Both full (`llms.txt`) and abridged (`llms-small.txt`) versions

### Advanced Development Features

#### Custom Plugins & Extensions

**Markdown Enhancement**:

- **rehype-autolink-headings**: Automatic heading links
- **rehype-tasklist-enhancer**: Enhanced task list styling
- **remark-fallback-lang**: Fallback language detection
- **remark-smartypants**: Typography improvements

**Development Tools**:

- **File Watcher**: Auto-reload on config changes
- **Link Checker**: Validates internal/external links
- **Slug Checker**: Ensures URL consistency
- **Error Documentation**: Auto-generated error reference

#### Custom Components Library

**Content Enhancement Components**:

- **TabGroup**: Multi-framework code examples
- **PackageManagerTabs**: npm/yarn/pnpm examples
- **Checklist**: Interactive task lists
- **Since**: Version-aware content
- **Badge**: Status and category indicators

**Layout Components**:

- **FluidGrid**: Responsive grid layouts
- **NavGrid**: Navigation card layouts
- **ShowcaseCard**: Featured content cards
- **RecipeLinks**: Cross-reference system

## Implementation Guide for Developers

### Setting Up a Similar Project

#### 1. Core Dependencies

```bash
npm install astro @astrojs/starlight
npm install @expressive-code/plugin-collapsible-sections
npm install starlight-llms-txt sharp
```

#### 2. Essential Configuration

**astro.config.ts**:

```typescript
import starlight from '@astrojs/starlight';
import { defineConfig } from 'astro/config';
import { sidebar } from './astro.sidebar';

export default defineConfig({
  integrations: [
    starlight({
      title: 'Your Docs',
      sidebar,
      defaultLocale: 'en',
      locales: {
        en: { label: 'English', lang: 'en' },
        // Add more languages
      },
      components: {
        Sidebar: './src/components/starlight/Sidebar.astro',
        // Override other components as needed
      }
    })
  ]
});
```

#### 3. Sidebar Structure

**astro.sidebar.ts**:

```typescript
import { group } from './config/sidebar';

export const sidebar = [
  group('start', {
    items: [
      'getting-started',
      group('basics', {
        items: ['first-steps', 'configuration']
      })
    ]
  }),
  group('guides', {
    items: [
      group('recipes', { 
        autogenerate: { directory: 'recipes' } 
      })
    ]
  })
];
```

#### 4. Content Schema Setup

**src/content.config.ts**:

```typescript
import { defineCollection, z } from 'astro:content';
import { docsLoader, docsSchema } from '@astrojs/starlight/loaders';

const baseSchema = z.object({
  type: z.literal('base').optional().default('base'),
  description: z.string().optional(),
});

export const collections = {
  docs: defineCollection({
    loader: docsLoader(),
    schema: docsSchema({ extend: baseSchema })
  })
};
```

### Best Practices

#### Content Organization

- **Separate concerns**: Keep configuration, content, and components in distinct directories
- **Use schemas**: Define content types for consistency and validation
- **Plan for i18n**: Structure content for easy translation from day one
- **Leverage autogeneration**: Use directory scanning for large content sections

#### Performance Optimization

- **Minimal JavaScript**: Let Astro's islands handle interactivity
- **Image optimization**: Use Sharp service for production builds
- **Build caching**: Structure builds for maximum cache efficiency
- **Link validation**: Implement automated link checking

#### Maintainability

- **Component overrides**: Only override Starlight components when necessary
- **Consistent naming**: Use clear, descriptive names for all files and functions
- **Documentation**: Document custom configurations and component modifications
- **Testing**: Implement link checking, build validation, and content linting

## Key Advantages of This Architecture

### Developer Experience

- âœ… **Type Safety**: Full TypeScript integration with content validation
- âœ… **Hot Reload**: Fast development with automatic config reloading
- âœ… **Extensible**: Easy to add new content types and components
- âœ… **Maintainable**: Clear separation of concerns and consistent patterns

### Content Management

- âœ… **Flexible Structure**: Mix manual curation with automatic generation
- âœ… **Schema Validation**: Prevents content errors at build time
- âœ… **Internationalization**: Comprehensive multi-language support
- âœ… **AI-Friendly**: Optimized content for LLM consumption

### User Experience

- âœ… **Fast Performance**: Astro's islands architecture minimizes JavaScript
- âœ… **Responsive Design**: Mobile-first responsive components
- âœ… **Accessibility**: WCAG compliant navigation and content structure
- âœ… **SEO Optimized**: Rich metadata and structured data

### Production Ready

- âœ… **Scalable**: Handles large documentation sites efficiently
- âœ… **Deployable**: Production-ready build system and deployment pipeline
- âœ… **Monitorable**: Built-in link checking and content validation
- âœ… **Maintainable**: Clear architecture and comprehensive documentation
